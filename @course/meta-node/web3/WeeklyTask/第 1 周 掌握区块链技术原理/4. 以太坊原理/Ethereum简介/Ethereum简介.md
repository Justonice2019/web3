## 一、以太坊简介

以太坊是一款于 2015 年 7 月正式投入运行的领先区块链底层平台，它支持去中心化应用（DApp）的开发和运行，其定位类似于智能手机中的安卓或 iOS 系统对 App 的支持。以太坊不仅支持原生货币 Ether（ETH），还引入了智能合约这一关键创新。2016 年，以太坊因为 “The DAO” 事件进行了一次重大硬分叉，最终分裂为两个链：以太坊（ETH）与以太坊经典（ETC）。

### 1. 背景

以太坊概念最早于 2013 年由《比特币杂志》的联合创始人 Vitalik Buterin 提出，并在同年发布白皮书。白皮书提出“通用区块链”的思想：区块链不仅限于货币交易，还可以执行任意可编程逻辑。Vitalik 指出，比特币的脚本语言不具备图灵完备性，无法运行复杂应用，因此提出构建一个基于图灵完备语言的智能合约平台，允许在链上编写自动执行的合约逻辑。

### 2. 发展事记

- **2013 年底**：Vitalik Buterin 发布以太坊白皮书，并召集 Gavin Wood、Jeffrey Wilcke、Charles Hoskinson、Anthony Di Iorio、Joseph Lubin 等联合创始人，共同启动项目。
- **2014 年 1 月**：以太坊在迈阿密的北美比特币大会首次对外亮相。
- **2014 年 4 月**：Gavin Wood 发布技术黄皮书（Ethereum Yellow Paper），详细描述以太坊虚拟机（EVM）和底层运行机制。
- **2014 年 7 月 24 日**：以太坊代币预售（crowdsale）开始，历时 42 天，共募集 31,531 BTC（约 1843 万美元），售出约 60,102,216 ETH。
- **2015 年 5 月**：最后一个测试网络（POC9）发布，代号 Olympic。
- **2015 年 7 月**：Frontier（主网早期版本）上线，标志主网正式运行。
- **2016 年 7 月**：The DAO 事件后分叉，网络分裂为 ETH（硬分叉链）与 ETC（原链，坚持不可篡改原则）。
- **2017 年**：企业以太坊联盟（EEA）成立，推动企业级区块链应用。
- **2018 年**：以太坊保持为市值第二大的加密资产（在多数时间段内）。
- **2021 年**：London 升级包含 EIP-1559，引入 BaseFee 与小费（Priority Fee）机制，改变手续费经济模型。同年 Visa 等机构扩大与以太坊生态的互动。
- **2022 年 9 月 15 日**：The Merge 实现，共识从 PoW 转为 PoS（权益证明），以太坊进入无挖矿（无 PoW）时代。
- **2023 年 4 月**：Shanghai（也称 Shapella）升级允许验证者提取质押的 ETH（withdrawals）。
- **2024 年前后**：以太坊推进包括 EIP-4844（Proto-Danksharding）在内的扩容与 Rollup 友好改进，路线图聚焦 Rollup + Daten/Proto-Danksharding + 未来分片（Danksharding）。

#### The DAO 事件（更严谨的技术说明）

The DAO 是一个在以太坊上运行的去中心化投资基金类 DApp，在 2016 年众筹期间募集了大量 ETH。合约存在重入漏洞（reentrancy）：在对外转账后未即时更新余额，攻击者通过递归调用（在外部调用返回前再度调用合约）重复提取资金，导致大量 ETH 被转移到攻击者控制的合约中（约 360 万 ETH 被“锁入”子 DAO 地址）。

社区最初讨论软分叉用于冻结资金，但由于技术、兼容性及中心化风险等问题，最终决定采用硬分叉来将被盗资金恢复到原持有者。2016 年 7 月硬分叉执行后，部分社区成员反对修改链历史，坚持不可篡改原则，继续维护原链（即后来的 Ethereum Classic，ETC）。这一事件引发了关于“代码即法律”、“链上治理”和智能合约安全的长期讨论，也直接推动了智能合约安全审计实践的发展。

### 3. 升级计划（按阶段与关键升级概述）

以太坊的发展可以分为若干演进阶段与关键分叉（升级）：

- **Frontier（2015）**：面向开发者的早期主网；为挖矿与合约开发提供基础设施。
- **Homestead（2016）**：改进语言与协议安全、引入 EIP 流程。
- **Metropolis（Byzantium / Constantinople / Istanbul）**：一系列性能与功能改进（引入 REVERT opcode、延缓难度炸弹、若干 gas 优化等）。
- **Serenity（通常称作 Ethereum 2.0 或更准确地：Execution Layer + Consensus Layer 分离）**：
  - **Beacon Chain / Phase 0（2020-12）**：PoS 信标链启动（不处理执行层交易）。
  - **The Merge（2022-09）**：执行层与共识层合并，正式完成从 PoW 到 PoS 的共识转移。
  - **Shanghai/Shapella（2023-04）**：允许验证者取回质押 ETH（withdrawals）。
  - **后续**：Proto-Danksharding（EIP-4844）、完整分片（Danksharding）与 Rollup 优化等，目标是显著降低 Layer2 成本并提高吞吐量。

### 4. “以太坊 2.0”命名（术语更新）

社区已逐步弃用“以太坊 2.0”作为单一版本号，而采用更精确的术语：

- **Execution Layer（执行层）**：负责交易执行、智能合约逻辑（原 Ethereum 1.x 功能）。
- **Consensus Layer（共识层）**：负责区块链共识（现在为 PoS 信标链与验证者集合）。

当前以太坊的发展目标是通过共识层（PoS） + 执行层改进（EIPs） + Rollups + Proto-Danksharding 来实现可扩展性和降低链上成本。

---

## 二、如何使用以太坊平台

#### 1. 在浏览器扩展商店安装 MetaMask 插件

MetaMask 是主流的以太坊钱包扩展（非唯一选择），支持注入式钱包交互，开发者可以通过其注入的 `window.ethereum` 与 dApp 交互。

#### 2. 设置密码

MetaMask 会要求设置本地加密密码，用于加密钱包数据（仅用于本地浏览器解锁），但真正控制账户的是助记词/私钥，不是这个密码。

#### 3. 助记词与私钥

助记词（通常是 12 或 24 个单词）是 BIP-39 标准的种子短语，用以派生私钥和地址。助记词等同于私钥的备份，必须离线、安全地保存；一旦泄露，账户资产将被即时窃取。**切勿将助记词或私钥输入不受信任的网站或保存到云端笔记中。**

#### 4. 注册与登录

使用 MetaMask 创建钱包后，会生成一个或多个地址（账户）。地址可公开用于收款，账户余额可以在主网或测试网上查看。主网地址余额代表真实资产，任何主网交易都会消耗真实 ETH。

#### 5. 使用测试网

常见测试网（随时间变化）包括：**Goerli、Sepolia、Holesky（开发/实验网）**。Rinkeby、Ropsten 等历史测试网已逐步退役。测试网 ETH 可通过公开水龙头（Faucet）领取，供开发与测试使用，且无实际价值。

> 注意：不同钱包/节点可能对测试网名称或可用性有差异，请以钱包或以太坊客户端的当前支持为准。

#### 6. Gas（手续费）基础

在 EIP-1559 之前，交易费用由 `gas_price` 决定；EIP-1559 后，交易费用由两部分构成：

- **BaseFee**（基础费）：按区块动态调整并由协议自动销毁（burn）。
- **Priority Fee**（小费 / Tip）：用户给矿工/打包者的额外激励，用于提升交易优先级。
- **Gas Used**：交易实际消耗的 gas 数量。

实际费用计算：  
`实际费用 = gas_used × (base_fee + priority_fee)`

对于普通转账，常用 gas limit 为 `21000`。合约交互的 gas 用量依合约复杂度而定。

---

## 三、以太坊核心概念

### 1. 账户和地址

- **外部拥有账户（EOA, Externally Owned Account）**：由私钥控制，能够发起交易与签名。
- **合约账户（Contract Account）**：由部署的智能合约代码控制，不能用私钥签名，只有在被交易或其他合约调用时才会执行其代码。

合约地址通常由创建者地址与创建时的 nonce 派生（或 CREATE2 指令可用不同方式生成）。

### 2. 消息与交易

- **消息（message/call）**：通常指合约间的内部调用（合约 A 调用合约 B 时的内部消息），这些可以在交易执行过程中产生，分为“call”、“delegatecall”、“staticcall”等不同语义。
- **交易（transaction）**：由外部账户签名并广播到网络的操作包，可能是以太币转账、合约部署或合约方法调用。交易具有 `nonce`、`gas_limit`、`gas_fee`、`to`、`value`、`data` 等字段。

如果交易在执行过程中耗尽 gas，已改变的状态会回滚，但已消耗的 gas 不会退还。

### 3. 区块结构

以太坊区块包含三大部分：区块头（Header）、交易列表（Transactions）、Ommer（以前称 Uncle）头。区块头包含父哈希、状态树根（stateRoot）、交易树根（txRoot）、收据树根（receiptsRoot）、时间戳、矿工/打包者地址等信息。

### 4. 以太坊节点类型

- **Full Node（全节点）**：存储并验证所有区块和交易，可独立判断链状态。
- **Light Node（轻节点）**：仅下载区块头并通过 Merkle 路径等方式验证特定交易，适合资源受限设备。
- **Validator（验证者节点，PoS）**：在 PoS 模式下，验证器负责提议与证明区块的有效性，需质押 ETH 成为验证者。
- **Archive Node（归档节点）**：保留所有历史状态（包括每个区块后的所有账户存储历史），存储开销巨大，常用于链上数据查询与分析。

### 5. 挖矿与共识（PoW vs PoS）

以太坊在 2022 年前采用 PoW（Ethash）；The Merge 后主网共识改为 PoS（Casper / Beacon Chain 体系）。两者核心差异：

- **PoW（工作量证明）**：
  - 通过算力竞争找到满足难度的区块头哈希。
  - 优点：实现简单、长时间验证理论稳健。
  - 缺点：能源消耗大、易产生算力集中与矿池中心化风险、51% 攻击理论风险。

- **PoS（权益证明）**：
  - 节点通过质押 ETH 成为验证者，依靠随机性和质押量进行选举。
  - 优点：能源消耗极低、设计以经济激励约束恶意行为、便于链上升级与治理。
  - 缺点：需要复杂的惩罚（slashing）与经济安全模型，质押集中与“富者越富”问题需通过协议与经济设计缓解。

安全性与去中心化特点依赖于网络参与者分布、质押分布与激励机制，PoS 的数学安全性模型与 PoW 不同，但社区与研究者持续评估其安全保证。

### 6. 以太坊虚拟机（EVM）

EVM 是以太坊的执行引擎，提供隔离的执行环境，用于运行智能合约字节码。其特点包括：

- 基于栈的架构（最大栈深度为 1024，字宽 256 位）。
- 指令集（opcode）涵盖算术、逻辑、存储、环境信息、合约调用等。
- EVM 状态由账户（外部账户与合约账户）与全局状态树（Merkle Patricia Trie / Merkle-Patricia Trie）维护。
- 多个 EVM 兼容实现存在（Geth、Nethermind、Erigon、Besu、OpenEthereum 等），以及 EVM 的改进与替代实现（eWASM 曾是讨论方向之一，后来路线更多聚焦于 EVM 兼容改进与扩展）。

### 7. 数字资产与单位

以太坊原生资产是 **Ether（ETH）**。最小单位是 **wei**：

- `1 ETH = 10^18 wei`  
常用单位还包括 Gwei（`1 Gwei = 10^9 wei`），常用于表示 gas price。

---

## 四、智能合约

#### 1. 定义

智能合约是部署在区块链上的可执行代码，部署后在链上运行并对外提供函数接口。一旦部署（并被交易确认），合约代码在区块链上是可见且可以被任意人调用。智能合约用于实现去中心化业务逻辑、自动执行条款和代币标准（如 ERC-20、ERC-721、ERC-1155 等）。

需要注意的关键点：

- 智能合约并非完全不可更改：有些合约采用可升级模式（代理模式、EIP-1822 等）允许逻辑升级，但这需要额外的设计与治理；
- 合约安全性极其重要：常见漏洞包括重入攻击、整数溢出、访问控制缺陷、错误的权限检查、前端信任问题等；
- 合约一旦对外暴露接口且有资产流入，其行为会受到链上不可逆交易的限制，错误修复成本高，需要事先充分审计和测试。

#### 2. 适用场景

智能合约适合规则明确、可形式化表达并且受益于自动化执行的场景，例如：

- 去中心化金融（DeFi）：自动化做市、借贷、抵押、清算；
- 代币发行与管理（ERC-20、ERC-721 等）；
- 去中心化自治组织（DAO）与治理合约；
- 供应链与溯源：链上记录与可验证的事件；
- 保险与衍生品（规则明确且可验证的触发条件）；
- 众筹、限时拍卖、时间锁与多签钱包等。

智能合约不适合强依赖人工判断、隐私高度敏感或需要高度可撤销的场景（除非结合链外或混合架构）。

---

## 五、常见术语速查

- **EVM**：以太坊虚拟机（执行合约的沙箱环境）。
- **Geth / Nethermind / Erigon / Besu**：主流以太坊客户端实现。
- **EIP（Ethereum Improvement Proposal）**：以太坊改进提案标准（如 EIP-1559、EIP-4844）。
- **Nonce**：账户的交易计数器，用于防止重放与保证交易顺序。
- **Gas Limit / Gas Price（旧术语） / BaseFee / Priority Fee（新模型）**。

---

## 六、实践建议与安全要点

1. **助记词安全**：助记词离线保存（硬件钱包、纸质或专用冷存储）。切勿在不可信设备或截图中保存助记词。  
2. **合约审计**：生产环境合约应经过专业审计与多方测试（单元测试、集成测试、模糊测试）。常见审计目标包括访问控制、重入、未初始化、授权检查等。  
3. **使用成熟工具链**：开发合约可使用 Hardhat、Foundry、Truffle 等工具，结合 OpenZeppelin 等成熟库以减少错误。  
4. **分级权限与多签**：关键操作（提取、升级）建议采用多签或时间锁治理减少单点失误。  
5. **费用估算与保护**：合约调用尽量做 gas 优化；前端应提供 gas 估算并优先提示用户确认。  
6. **测试网先行**：在主网部署前尽量在多个测试网（如 Sepolia、Goerli）或本地链（Hardhat Network）做充分验证。  
7. **监控与响应**：生产合约需配合链上事件报警、监控脚本和速断机制（例如发现异常立即触发暂停/紧急停止函数）。  

---

